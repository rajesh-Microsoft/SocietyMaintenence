<!--
Maintenance Tracker - JSON version (data pulled from Azure Blob Storage)
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Society Maintenance Tracker</title>
  <style>
    :root{--bg:#f6f8fc;--card:#ffffff;--text:#0f172a;--muted:#6b7280;--primary:#0b63e6;--primary-weak:#eef2ff;--border:#e5e7eb;--shadow:0 8px 24px rgba(15,23,42,0.06);--radius:12px}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;padding:16px;background:var(--bg);color:var(--text);line-height:1.45}
    .ticker{position:relative;overflow:hidden;background:#fffbe6;border:1px solid #fde68a;color:#92400e;border-radius:8px;margin:0 0 12px 0}
    .ticker__track{white-space:nowrap;display:flex;gap:48px;padding:8px 12px;animation:tickerMove 25s linear infinite}
    @keyframes tickerMove{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
    .banner{background:#fff7ed;color:#7c2d12;border:1px solid #fed7aa;border-radius:10px;padding:10px 12px;margin:0 0 12px 0;box-shadow:0 2px 8px rgba(15,23,42,0.04)}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
    h1{margin:0 0 8px 0;font-size:20px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type=text], select{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff}
    input[type=text]:focus, select:focus{outline:2px solid rgba(11,99,230,0.2)}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--primary);color:#fff;cursor:pointer;box-shadow:0 2px 6px rgba(11,99,230,0.2)}
    button:hover{filter:brightness(0.98)}
    button:active{transform:translateY(1px)}
    button.ghost{background:var(--primary-weak);color:var(--primary)}
    .tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:16px}
    .tab{flex:1;padding:12px 16px;background:transparent;border:0;border-bottom:3px solid transparent;color:var(--muted);cursor:pointer;font-weight:500;transition:all 0.2s ease}
    .tab:hover{color:var(--text);background:var(--primary-weak)}
    .tab.active{color:var(--primary);border-bottom-color:var(--primary);background:var(--primary-weak)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    table.table{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
    th,td{padding:12px 12px;border-bottom:1px solid #eef2f6;text-align:left;vertical-align:middle}
    th{background:linear-gradient(180deg,#fbfdff,#f3f8ff);position:sticky;top:0;z-index:1;font-weight:600}
    tbody tr:nth-child(even) td{background:#fcfdff}
    tbody tr:hover td{background:#f7faff}
    thead tr:last-child th{background:#ffffff;position:sticky;top:42px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;background:#f1f5f9;color:#334155}
    .paid{background:#dcfce7;color:#14532d}
    .unpaid{background:#fee2e2;color:#991b1b}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .stat{padding:10px 12px;background:#f8fafc;border-radius:10px;border:1px solid #eef2f6;display:flex;align-items:center;gap:8px}
    .small{font-size:12px;color:#475569}
    .muted{color:var(--muted)}
    .search{flex:1;min-width:200px}
    .table-wrap{max-height:60vh;overflow:auto;border-radius:10px;border:1px solid var(--border);background:#fff}
    .action-link{cursor:pointer;color:var(--primary);text-decoration:none}
    .eye{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:var(--primary-weak);color:var(--primary)}
    .eye:hover{filter:brightness(0.97)}
    .eye.active{background:var(--primary);color:#fff}
    .divider{height:1px;background:#eef2f6;margin:8px 0}
    @media (max-width: 1024px){
      .chart-grid{grid-template-columns: 1fr 1fr !important; gap: 10px !important}
      .chart-grid .card:nth-child(3){grid-column: 1 / -1; margin-top: 10px}
    }
    @media (max-width: 720px){
      body{padding:12px}
      h1{font-size:18px}
      .controls{gap:6px}
      button, input[type=text], select{width:100%}
      .table-wrap{max-height:none}
      th,td{padding:8px;font-size:14px}
      .stat{width:100%;justify-content:space-between}
      .chart-grid{grid-template-columns: 1fr !important; gap: 8px !important}
      .chart-grid .card{padding: 8px !important}
      .chart-grid h3{font-size: 12px !important; margin-bottom: 6px !important}
      .chart-grid div[style*="height"]{height: 120px !important}
    }
  </style>
</head>
<body>
  <div class="ticker">
    <div class="ticker__track">
      <span>"This app is currently under development, so some data may be inconsistent. Don‚Äôt worry‚Äîwe‚Äôre on it and will take care of everything.</span>
      <span>This app is currently under development, so some data may be inconsistent. Don‚Äôt worry‚Äîwe‚Äôre on it and will take care of everything.</span>
      <span>This app is currently under development, so some data may be inconsistent. Don‚Äôt worry‚Äîwe‚Äôre on it and will take care of everything".</span>
    </div>
  </div>
  <div class="banner">
    <strong>üí° Reminder:</strong> Please pay your maintenance before 10th of every month via UPI <strong>7697806560icici@ybl</strong>.
  </div>
  <div class="card">
    <h1>üè¢ NLC Aadya Society Maintenance Tracker</h1>
    <div class="small muted">üìä This app pulls maintenance data directly from Azure Blob Storage JSON file and displays, filters, and exports the status.</div>
  </div>

  <div class="card" id="topSummaryCard" style="display:none">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px">
      <h1 style="margin:0">üìà Summary</h1>
      <div class="small muted" id="lastUpdated"></div>
    </div>
    <div class="controls" style="margin: 8px 0 12px 0">
      <select id="monthFilter"><option value="all">üìÖ All Months</option></select>
      <button id="clearFiltersSummary" class="ghost">üóëÔ∏è Clear Filters</button>
    </div>
    <div class="stats" id="topSummary"></div>
    <div class="stats" id="stats"></div>
    <div class="small muted" id="filterSummary"></div>
    
    <!-- Charts Section -->
    <div style="margin-top: 16px;">
      <div class="chart-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
        <div class="card" style="margin-bottom: 0; padding: 12px;">
          <h3 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text);">üìä Payment Status</h3>
          <div style="height: 150px; position: relative;">
            <canvas id="paymentStatusChart"></canvas>
          </div>
        </div>
        <div class="card" style="margin-bottom: 0; padding: 12px;">
          <h3 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text);">üìà Monthly Collections</h3>
          <div style="height: 150px; position: relative;">
            <canvas id="monthlyChart"></canvas>
          </div>
        </div>
        <div class="card" style="margin-bottom: 0; padding: 12px;">
          <h3 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text);">üí∏ Expenses vs Collections</h3>
          <div style="height: 150px; position: relative;">
            <canvas id="expensesChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tabs">
      <button id="tabCollected" class="tab active">üí∞ Collected</button>
      <button id="tabExpenses" class="tab">üí∏ Expenses</button>
      <button id="tabFuture1" class="tab">üîÆ Future 1</button>
      <button id="tabFuture2" class="tab">üöÄ Future 2</button>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <button id="exportExcel">üìä Export Excel</button>
      <button id="exportCsv" class="ghost">üìÑ Export CSV</button>
      <input id="searchBox" class="search" type="text" placeholder="üîç Search name/flat/contact..." />
    </div>
  </div>


  <div class="card table-wrap">
    <div id="collectedContent" class="tab-content active">
      <div id="tableContainer"></div>
    </div>
    <div id="expensesContent" class="tab-content">
      <div id="expensesTableContainer"></div>
    </div>
    <div id="future1Content" class="tab-content">
      <div class="small muted">üîÆ Future 1 functionality coming soon...</div>
    </div>
    <div id="future2Content" class="tab-content">
      <div class="small muted">üöÄ Future 2 functionality coming soon...</div>
    </div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const exportExcelBtn = document.getElementById('exportExcel');
    const exportCsvBtn = document.getElementById('exportCsv');
    const clearFiltersSummaryBtn = document.getElementById('clearFiltersSummary');
    const searchBox = document.getElementById('searchBox');
    const statsDiv = document.getElementById('stats');
    const tableContainer = document.getElementById('tableContainer');
    const monthFilter = document.getElementById('monthFilter');
    const tabCollectedBtn = document.getElementById('tabCollected');
    const tabExpensesBtn = document.getElementById('tabExpenses');
    const tabFuture1Btn = document.getElementById('tabFuture1');
    const tabFuture2Btn = document.getElementById('tabFuture2');
    const filterSummary = document.getElementById('filterSummary');
    const topSummaryCard = document.getElementById('topSummaryCard');
    const topSummaryDiv = document.getElementById('topSummary');

    let rawData = [];
    let columnFilters = {};
    let expensesData = [];
    let expensesColumnFilters = {};
    let currentTab = 'collected'; // collected | expenses | future1 | future2
    let paidView = 'all'; // all | paid | unpaid
    let ADMIN_PASSWORD = 'admin123';
    let UPDATE_ENDPOINT = null; // optional, can be set via config.json
    let UPDATE_BLOB_SAS_URL = null; // optional SAS URL with write perms to maintenance_data.json
    const READ_JSON_URL = "https://societymantaintracker.blob.core.windows.net/files/maintenance_data.json";
    let summaryData = [];
    let charts = {
      paymentStatus: null,
      monthly: null,
      expenses: null
    };

    function normalizeKey(k){return (k||'').toString().trim().toLowerCase();}
    
    function getColumnIcon(columnName){
      const iconMap = {
        'Month': 'üìÖ',
        'Name': 'üë§',
        'Flat': 'üè†',
        'Amount': 'üí∞',
        'Paid': '‚úÖ',
        'PaymentDate': 'üìÜ',
        'Payment Mode': 'üí≥',
        'Reference/Transaction ID': 'üîó',
        'Notes': 'üìù',
        'Date': 'üìÜ',
        'Description': 'üìÑ',
        'Category': 'üìÇ',
        'Amount Spent': 'üí∏',
        'Actions': '‚öôÔ∏è'
      };
      return iconMap[columnName] || '';
    }

    function renderCharts() {
      renderPaymentStatusChart();
      renderMonthlyChart();
      renderExpensesChart();
    }

    function renderPaymentStatusChart() {
      const ctx = document.getElementById('paymentStatusChart');
      if (!ctx) return;

      // Destroy existing chart
      if (charts.paymentStatus) {
        charts.paymentStatus.destroy();
      }

      const data = getCollectedBaseFiltered();
      const paid = data.filter(r => r.__paid).length;
      const unpaid = data.filter(r => !r.__paid).length;

      charts.paymentStatus = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Paid', 'Unpaid'],
          datasets: [{
            data: [paid, unpaid],
            backgroundColor: ['#22c55e', '#ef4444'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 8,
                usePointStyle: true,
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    function renderMonthlyChart() {
      const ctx = document.getElementById('monthlyChart');
      if (!ctx) return;

      // Destroy existing chart
      if (charts.monthly) {
        charts.monthly.destroy();
      }

      const monthData = {};
      rawData.forEach(row => {
        if (row.Month && row.Amount) {
          if (!monthData[row.Month]) {
            monthData[row.Month] = 0;
          }
          monthData[row.Month] += parseFloat(row.Amount) || 0;
        }
      });

      const months = Object.keys(monthData).sort();
      const amounts = months.map(month => monthData[month]);

      charts.monthly = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Collections (‚Çπ)',
            data: amounts,
            backgroundColor: '#3b82f6',
            borderColor: '#1d4ed8',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 10
                },
                callback: function(value) {
                  return '‚Çπ' + value.toLocaleString();
                }
              }
            },
            x: {
              ticks: {
                font: {
                  size: 10
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    function renderExpensesChart() {
      const ctx = document.getElementById('expensesChart');
      if (!ctx) return;

      // Destroy existing chart
      if (charts.expenses) {
        charts.expenses.destroy();
      }

      const monthData = {};
      const expenseData = {};

      // Process collections
      rawData.forEach(row => {
        if (row.Month && row.Amount) {
          if (!monthData[row.Month]) {
            monthData[row.Month] = 0;
          }
          monthData[row.Month] += parseFloat(row.Amount) || 0;
        }
      });

      // Process expenses
      expensesData.forEach(row => {
        const month = row.__Month || getMonthNameFromDateValue(row.Date);
        if (month) {
          if (!expenseData[month]) {
            expenseData[month] = 0;
          }
          expenseData[month] += parseFloat(row.Amount || row['Amount Spent'] || 0) || 0;
        }
      });

      const allMonths = [...new Set([...Object.keys(monthData), ...Object.keys(expenseData)])].sort();
      const collections = allMonths.map(month => monthData[month] || 0);
      const expenses = allMonths.map(month => expenseData[month] || 0);

      charts.expenses = new Chart(ctx, {
        type: 'line',
        data: {
          labels: allMonths,
          datasets: [
            {
              label: 'Collections',
              data: collections,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Expenses',
              data: expenses,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 10
                },
                callback: function(value) {
                  return '‚Çπ' + value.toLocaleString();
                }
              }
            },
            x: {
              ticks: {
                font: {
                  size: 10
                }
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 8,
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }
    function toBooleanPaid(val){
      if(val===true) return true;
      if(val===false) return false;
      if(val==null) return false;
      const s = String(val).trim().toLowerCase();
      if(['yes','y','paid','true','1','done'].includes(s)) return true;
      return false;
    }

    function excelSerialToJSDate(serial){
      const utc_days = Math.floor(serial - 25569);
      const utc_value = utc_days * 86400;
      const fractional_day = serial - Math.floor(serial);
      const seconds = Math.round(86400 * fractional_day);
      const date = new Date((utc_value + seconds) * 1000);
      return new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
    }
    function formatDate(val){
      if(val === null || val === undefined || val === '') return '';
      if(val instanceof Date && !isNaN(val)){
        const d = val.getDate().toString().padStart(2,'0');
        const m = (val.getMonth()+1).toString().padStart(2,'0');
        const y = val.getFullYear();
        return d+"-"+m+"-"+y;
      }
      if(typeof val === 'number' && !isNaN(val)){
        try{ return formatDate(excelSerialToJSDate(val)); }catch(e){}
      }
      const s = String(val).trim();
      const parsed = Date.parse(s);
      if(!isNaN(parsed)) return formatDate(new Date(parsed));
      return s;
    }

    function getMonthNameFromDateValue(val){
      if(!val) return '';
      let d=null;
      if(val instanceof Date && !isNaN(val)) d=val;
      else if(typeof val==='number' && !isNaN(val)) { try{ d=excelSerialToJSDate(val); }catch(e){} }
      if(!d){
        const s=String(val).trim();
        const parsed=Date.parse(s);
        if(!isNaN(parsed)) d=new Date(parsed);
      }
      if(!d || isNaN(d)) return '';
      return d.toLocaleString(undefined,{month:'long'});
    }

    function renderCollectedStats(data){
      const total = data.length;
      const paid = data.filter(r=>r.__paid).length;
      const unpaid = total - paid;
      const collected = data.reduce((s,r)=>s + (parseFloat(r.Amount||0)||0),0);
      statsDiv.innerHTML = `
        <div class="stat">üìä <strong>${total}</strong> total</div>
        <div class="stat">‚úÖ <strong>${paid}</strong> paid <span id="paidEye" class="eye${paidView==='paid'?' active':''}" title="View paid">üëÅ</span></div>
        <div class="stat">‚ùå <strong>${unpaid}</strong> unpaid <span id="unpaidEye" class="eye${paidView==='unpaid'?' active':''}" title="View unpaid">üëÅ</span></div>
      `;
      const paidEye = document.getElementById('paidEye');
      const unpaidEye = document.getElementById('unpaidEye');
      if(paidEye){ paidEye.addEventListener('click',()=>{ paidView = (paidView==='paid' ? 'all' : 'paid'); render(); }); }
      if(unpaidEye){ unpaidEye.addEventListener('click',()=>{ paidView = (paidView==='unpaid' ? 'all' : 'unpaid'); render(); }); }
    }

    function renderExpensesStats(data){
      const total = data.length;
      const spent = data.reduce((s,r)=>s + (parseFloat(r.Amount||r.amount||0)||0),0);
      statsDiv.innerHTML = `
        
      `;
    }

    function renderTopSummary(){
      const selectedMonth = monthFilter.value;
      // If no month selected filter or 'all', show provided summaryData
      if(selectedMonth==='all'){
        if(!summaryData || !summaryData.length){ topSummaryCard.style.display='none'; return; }
        const items = summaryData
          .filter(x=>x && x.Metric!=null && x.Value!=null)
          .map(x=>({metric:String(x.Metric), value:Number(x.Value)}));
        if(!items.length){ topSummaryCard.style.display='none'; return; }
        topSummaryCard.style.display='';
        topSummaryDiv.innerHTML = items.map(x=>`<div class="stat"><strong>${x.metric}</strong> <span>‚Çπ ${x.value.toLocaleString(undefined,{maximumFractionDigits:2})}</span></div>`).join('');
        return;
      }
      // Month-specific summary computed from current data
      const monthCollected = rawData
        .filter(r=>r && r.Month===selectedMonth)
        .reduce((s,r)=> s + (parseFloat(r.Amount||0)||0), 0);
      const monthExpenses = expensesData
        .filter(e=>{
          const m = e.__Month || getMonthNameFromDateValue(e.Date);
          return (m||'').toLowerCase() === selectedMonth.toLowerCase();
        })
        .reduce((s,e)=> s + (parseFloat(e.Amount||e['Amount Spent']||0)||0), 0);
      const monthItems = [
        { metric: 'Total Collections', value: monthCollected },
        { metric: 'Total Expenses', value: monthExpenses },
        { metric: 'Net Balance', value: monthCollected - monthExpenses }
      ];
      topSummaryCard.style.display='';
      topSummaryDiv.innerHTML = monthItems.map(x=>`<div class=\"stat\"><strong>${x.metric}</strong> <span>‚Çπ ${x.value.toLocaleString(undefined,{maximumFractionDigits:2})}</span></div>`).join('');
    }

    function getCollectedBaseFiltered(){
      const filter = paidView;
      const q = (searchBox.value||'').trim().toLowerCase();
      const selectedMonth = monthFilter.value;
      return rawData.filter(row=>{
        if(selectedMonth !== 'all' && row.Month && row.Month !== selectedMonth) return false;
        if(filter==='paid' && !row.__paid) return false;
        if(filter==='unpaid' && row.__paid) return false;
        if(q){
          const hay = Object.values(row).join(' ').toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }
    function getCollectedDisplay(){
      const baseFiltered = getCollectedBaseFiltered();
      return baseFiltered.filter(row=>{
        for(const key in columnFilters){
          const val = (columnFilters[key]||'').toString().trim();
          if(!val) continue;
          if(key==='Paid'){
            if(val==='paid' && !row.__paid) return false;
            if(val==='unpaid' && row.__paid) return false;
            continue;
          }
          const cell = row[key];
          const cellStr = (cell==null? '' : String(cell));
          if(cellStr !== val) return false;
        }
        return true;
      });
    }
    function renderCollectedTable(){
      const baseFiltered = getCollectedBaseFiltered();
      const display = getCollectedDisplay();

      renderCollectedStats(display);

      if(display.length===0){ tableContainer.innerHTML = '<div class="small muted">üìã No records to show</div>'; return; }

      const cols = Object.keys(display[0]).filter(c=>!c.startsWith('__'));
      const table = document.createElement('table');
      table.className = 'table';
      table.className = 'table';
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      cols.forEach(c=>{ 
        const th = document.createElement('th'); 
        const icon = getColumnIcon(c);
        th.innerHTML = icon ? `${icon} ${c}` : c; 
        trh.appendChild(th); 
      });
      // Actions header
      const thAct = document.createElement('th'); 
      const actionsIcon = getColumnIcon('Actions');
      thAct.innerHTML = actionsIcon ? `${actionsIcon} Actions` : 'Actions'; 
      trh.appendChild(thAct);
      thead.appendChild(trh);
      // filters row with dropdowns populated from baseFiltered unique values
      const trf = document.createElement('tr');
      cols.forEach(c=>{
        const th = document.createElement('th');
        const sel=document.createElement('select');
        if(c==='Paid'){
          sel.innerHTML='<option value="">All</option><option value="paid">Paid</option><option value="unpaid">Unpaid</option>';
        }else{
          const seen = new Set();
          const values = [];
          baseFiltered.forEach(r=>{
            const v = r[c];
            const s = (v==null? '' : String(v));
            if(s===''||seen.has(s)) return;
            seen.add(s); values.push(s);
          });
          values.sort((a,b)=>a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'}));
          const opts = ['<option value="">All</option>'].concat(values.map(v=>'<option value="'+v.replace(/"/g,'&quot;')+'">'+v.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</option>'));
          sel.innerHTML = opts.join('');
        }
        sel.value = (columnFilters[c]||'');
        sel.addEventListener('change',()=>{ columnFilters[c]=sel.value; render(); });
        th.appendChild(sel);
        trf.appendChild(th);
      });
      // empty cell for Actions column
      const thEmpty=document.createElement('th'); trf.appendChild(thEmpty);
      thead.appendChild(trf);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      display.forEach((row,idx)=>{
        const tr = document.createElement('tr');
        cols.forEach(c=>{
          const td = document.createElement('td');
          if(c==='Paid'){
            const isPaid = !!row.__paid;
            td.innerHTML = isPaid ? '<span class="badge paid">Paid</span>' : '<span class="badge unpaid">Unpaid</span>';
          }else{
            td.textContent = row[c] == null ? '' : row[c];
          }
          tr.appendChild(td);
        });
        // Actions cell
        const tdAct = document.createElement('td');
        const toggle = document.createElement('span'); toggle.className='action-link'; toggle.textContent = row.__paid? '‚ùå Mark Unpaid' : '‚úÖ Mark Paid';
        toggle.onclick = async ()=>{
          const pwd = prompt('Enter admin password');
          if(pwd==null) return; // cancelled
          if(pwd !== ADMIN_PASSWORD){ alert('Incorrect password'); return; }
          try{
            await applyPaidToggle(row, !row.__paid);
          }catch(e){
            alert('Failed to update: '+(e&&e.message? e.message : e));
            return;
          }
          render();
        };
        tdAct.appendChild(toggle);
        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      tableContainer.innerHTML='';
      tableContainer.appendChild(table);
    }

    function getExpensesBaseFiltered(){
      const q = (searchBox.value||'').trim().toLowerCase();
      const selectedMonth = monthFilter.value;
      return expensesData.filter(row=>{
        if(selectedMonth !== 'all'){
          const m = row.__Month || getMonthNameFromDateValue(row.Date);
          if((m||'').toLowerCase() !== selectedMonth.toLowerCase()) return false;
        }
        if(q){
          const hay = Object.values(row).join(' ').toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }
    function getExpensesDisplay(){
      const baseFiltered = getExpensesBaseFiltered();
      return baseFiltered.filter(row=>{
        for(const key in expensesColumnFilters){
          const val = (expensesColumnFilters[key]||'').toString().trim();
          if(!val) continue;
          const cell = row[key];
          const cellStr = (cell==null? '' : String(cell));
          if(cellStr !== val) return false;
        }
        return true;
      });
    }
    function renderExpensesTable(){
      const baseFiltered = getExpensesBaseFiltered();
      const display = getExpensesDisplay();

      renderExpensesStats(display);

      const expensesContainer = document.getElementById('expensesTableContainer');
      if(!display.length){ expensesContainer.innerHTML = '<div class="small muted">üí∏ No expenses to show</div>'; return; }

      const cols = Object.keys(display[0]);
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      cols.forEach(c=>{ 
        const th = document.createElement('th'); 
        const icon = getColumnIcon(c);
        th.innerHTML = icon ? `${icon} ${c}` : c; 
        trh.appendChild(th); 
      });
      thead.appendChild(trh);
      // filters row
      const trf = document.createElement('tr');
      cols.forEach(c=>{
        const th = document.createElement('th');
        const sel=document.createElement('select');
        const seen = new Set();
        const values = [];
        baseFiltered.forEach(r=>{
          const v = r[c];
          const s = (v==null? '' : String(v));
          if(s===''||seen.has(s)) return;
          seen.add(s); values.push(s);
        });
        values.sort((a,b)=>a.localeCompare(b, undefined, {numeric:true, sensitivity:'base'}));
        const opts = ['<option value="">All</option>'].concat(values.map(v=>'<option value="'+v.replace(/"/g,'&quot;')+'">'+v.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</option>'));
        sel.innerHTML = opts.join('');
        sel.value = (expensesColumnFilters[c]||'');
        sel.addEventListener('change',()=>{ expensesColumnFilters[c]=sel.value; renderExpensesTable(); });
        th.appendChild(sel);
        trf.appendChild(th);
      });
      thead.appendChild(trf);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      display.forEach(row=>{
        const tr = document.createElement('tr');
        cols.forEach(c=>{ const td=document.createElement('td'); td.textContent = row[c]==null? '' : row[c]; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      expensesContainer.innerHTML='';
      expensesContainer.appendChild(table);
    }

    function applyTabVisibility(){
      // Show/hide controls based on tab
      if(currentTab==='collected'){
        monthFilter.style.display='';
      }else{
        monthFilter.style.display='';
      }
    }

    function render(){
      applyTabVisibility();
      renderFilterSummary();
      renderTopSummary();
      renderCharts();
      if(currentTab==='collected') return renderCollectedTable();
      if(currentTab==='expenses') return renderExpensesTable();
      // Future tabs
      statsDiv.innerHTML = '<div class="stat">üîÆ Future tab</div>';
      tableContainer.innerHTML = '<div class="small muted">üöß Coming soon</div>';
    }

    function buildRowsFromMaintenanceJson(json){
      const rows = [];
      const sectionNames = Object.keys(json||{});
      sectionNames.forEach(section=>{
        if(['Expenses','Summary'].includes(section)) return;
        const list = Array.isArray(json[section]) ? json[section] : [];
        list.forEach(item=>{
          const ref = String(item['Reference/Transaction ID']||'');
          if(ref.toLowerCase().includes('total collections')) return;
          const amountNum = Number(item['Amount Received']||0) || 0;
          const flatRaw = item['Flat Number'];
          const flatVal = Number.isFinite(flatRaw) ? (Number.isInteger(flatRaw)? flatRaw : Math.trunc(flatRaw)) : (flatRaw||'');
          const row = {
            Month: section,
            Name: item['Resident Name']||'',
            Flat: flatVal,
            Amount: amountNum,
            Paid: amountNum>0 ? 'Paid' : '',
            PaymentDate: formatDate(item['Date']||''),
            'Payment Mode': item['Payment Mode']||'',
            //'Reference/Transaction ID': ref,
            Notes: item['Notes']||''
          };
          row.__paid = amountNum>0;
          rows.push(row);
        });
      });
      return rows;
    }

    function extractExpenses(json){
      const list = Array.isArray(json && json['Expenses']) ? json['Expenses'] : [];
      // Normalize Amount key and derive a Month label from Date
      return list.map(x=>{
        const r = Object.assign({}, x);
        if(r.Amount==null && r['Amount']) r.Amount = r['Amount'];
        r.__Month = getMonthNameFromDateValue(r.Date);
        return r;
      });
    }

    function normalizeRows(rows){
      return rows.map(r=>{
        const out = {};
        const aliases = {name:['name','owner','resident'], flat:['flat','flatno','flat no','flat_number'], amount:['amount','maintenance','fees'], paid:['paid','status'], paymentdate:['paymentdate','date'], contact:['contact','phone','mobile']};
        const lowerMap = {};
        for(const k of Object.keys(r)) lowerMap[normalizeKey(k)] = k;
        for(const target of ['Name','Flat','Amount','Paid','PaymentDate','Contact']){
          let foundKey=null;
          for(const alias of (aliases[target.toLowerCase()]||[])){
            if(lowerMap[alias]){foundKey=lowerMap[alias];break;}
          }
          if(!foundKey && lowerMap[target.toLowerCase()]) foundKey=lowerMap[target.toLowerCase()];
          if(foundKey) out[target]=r[foundKey];
        }
        for(const k of Object.keys(r)){
          if(['name','flat','amount','paid','paymentdate','contact'].includes(normalizeKey(k))) continue;
          out[k]=r[k];
        }
        out.__paid = toBooleanPaid(out.Paid);
        if(out.Amount) out.Amount=out.Amount.toString().replace(/[‚Çπ, ]/g,'');
        if(out.PaymentDate) out.PaymentDate = formatDate(out.PaymentDate);
        return out;
      });
    }

    function renderFilterSummary(){
      const badges = [];
      const search = (searchBox.value||'').trim();
      if(search){ badges.push(`<span class="badge">üîç Search: ${escapeHtml(search)}</span>`); }
      if(currentTab==='collected'){
        if(monthFilter.value && monthFilter.value!=='all') badges.push(`<span class="badge">üìÖ Month: ${escapeHtml(monthFilter.value)}</span>`);
        if(paidView==='paid') badges.push('<span class="badge">‚úÖ Paid</span>');
        if(paidView==='unpaid') badges.push('<span class="badge">‚ùå Unpaid</span>');
        for(const k in columnFilters){
          const v = columnFilters[k]; if(v) badges.push(`<span class="badge">${escapeHtml(k)}: ${escapeHtml(String(v))}</span>`);
        }
      }else if(currentTab==='expenses'){
        for(const k in expensesColumnFilters){
          const v = expensesColumnFilters[k]; if(v) badges.push(`<span class="badge">${escapeHtml(k)}: ${escapeHtml(String(v))}</span>`);
        }
      }
      filterSummary.innerHTML = badges.length? badges.join(' ') : 'üéØ No filters applied';
    }

    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function getCurrentDisplay(){
      if(currentTab==='expenses') return getExpensesDisplay();
      // default collected
      return getCollectedDisplay();
    }

    // Export CSV (current tab & filters)
    exportCsvBtn.addEventListener('click',()=>{
      const rows = getCurrentDisplay();
      if(!rows.length) return alert('No data');
      const cols=Object.keys(rows[0]).filter(c=>!c.startsWith('__'));
      const lines=[cols.join(',')];
      rows.forEach(r=>{lines.push(cols.map(c=>escapeCsv(r[c]||'')).join(','));});
      const blob=new Blob([lines.join('\n')],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const filename = currentTab==='expenses' ? 'expenses_export.csv' : 'maintenance_export.csv';
      downloadUrl(url, filename);
      URL.revokeObjectURL(url);
    });
    function escapeCsv(v){if(v==null) return ''; const s=String(v).replace(/"/g,'""'); if(s.includes(',')||s.includes('"')||s.includes('\n')) return '"'+s+'"'; return s;}

    // Export Excel (current tab & filters)
    exportExcelBtn.addEventListener('click',()=>{
      const rows = getCurrentDisplay();
      if(!rows.length) return alert('No data');
      const outRows=rows.map(r=>{const o={}; for(const k of Object.keys(r)) if(!k.startsWith('__')) o[k]=r[k]; return o;});
      const ws=XLSX.utils.json_to_sheet(outRows);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws, currentTab==='expenses' ? 'Expenses' : 'Maintenance');
      const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
      const blob=new Blob([wbout],{type:'application/octet-stream'});
      const url=URL.createObjectURL(blob);
      const filename = currentTab==='expenses' ? 'expenses_export.xlsx' : 'maintenance_export.xlsx';
      downloadUrl(url, filename);
      URL.revokeObjectURL(url);
    });
    function downloadUrl(url,filename){const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();}

    // Fetch JSON directly from Azure Blob Storage
    async function loadFromAzure(){
      try{
        const res = await fetch(READ_JSON_URL);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const lm = res.headers && res.headers.get ? res.headers.get('Last-Modified') : null;
        if(lm){
          const lmDate = new Date(lm);
          const lastUpdatedEl = document.getElementById('lastUpdated');
          if(lastUpdatedEl && !isNaN(lmDate)) lastUpdatedEl.textContent = 'Last updated: ' + lmDate.toLocaleString();
        }
        const json = await res.json();
        if(Array.isArray(json)){
          rawData = normalizeRows(json);
          expensesData = [];
          summaryData = [];
        }else{
          rawData = buildRowsFromMaintenanceJson(json);
          expensesData = extractExpenses(json);
          summaryData = Array.isArray(json && json['Summary']) ? json['Summary'] : [];
        }
        if(!rawData || !rawData.length) throw new Error('No records found');
        populateMonthFilter();
        renderTopSummary();
        render();
      }catch(err){
        tableContainer.innerHTML = '<div class="small muted">Error loading data: '+err.message+'</div>';
      }
    }

    // Optional config via inline <script id="app-config" type="application/json"> or config.json (http/https only)
    async function loadConfig(){
      try{
        // Inline JSON config support (works with file://)
        const inline = document.getElementById('app-config');
        if(inline && inline.textContent){
          try{
            const cfg = JSON.parse(inline.textContent);
            if(cfg && typeof cfg.adminPassword === 'string' && cfg.adminPassword.trim().length){ ADMIN_PASSWORD = cfg.adminPassword; }
            if(cfg && typeof cfg.updateEndpoint === 'string' && cfg.updateEndpoint.trim().length){ UPDATE_ENDPOINT = cfg.updateEndpoint; }
            if(cfg && typeof cfg.updateBlobSasUrl === 'string' && cfg.updateBlobSasUrl.trim().length){ UPDATE_BLOB_SAS_URL = cfg.updateBlobSasUrl; }
          }catch(_){}
        }
        // Skip network fetch on file:// to avoid CORS noise
        if(location && location.protocol === 'file:') return;
        const res = await fetch('config.json');
        if(!res.ok) return;
        const cfg = await res.json();
        if(cfg && typeof cfg.adminPassword === 'string' && cfg.adminPassword.trim().length){ ADMIN_PASSWORD = cfg.adminPassword; }
        if(cfg && typeof cfg.updateEndpoint === 'string' && cfg.updateEndpoint.trim().length){ UPDATE_ENDPOINT = cfg.updateEndpoint; }
        if(cfg && typeof cfg.updateBlobSasUrl === 'string' && cfg.updateBlobSasUrl.trim().length){ UPDATE_BLOB_SAS_URL = cfg.updateBlobSasUrl; }
      }catch(e){ /* ignore */ }
    }

    async function sendUpdateToBackend(row){
      if(!UPDATE_ENDPOINT) return; // no backend configured
      const payload = {
        action: row.__paid ? 'mark_paid' : 'mark_unpaid',
        row: row
      };
      await fetch(UPDATE_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    }

    function todayIso(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }

    async function applyPaidToggle(row, makePaid){
      // update local row first
      row.__paid = !!makePaid;
      row.Paid = row.__paid ? 'Paid' : '';
      row.PaymentDate = row.__paid ? formatDate(new Date()) : '';
      if(row.__paid){ row.Amount = 2000; }
      // Backend webhook
      if(UPDATE_ENDPOINT){
        await sendUpdateToBackend(row);
        return;
      }
      // Direct blob update if SAS URL provided
      if(!UPDATE_BLOB_SAS_URL) return;
      const res = await fetch(READ_JSON_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('Unable to fetch current JSON: HTTP '+res.status);
      const json = await res.json();
      const month = row.Month;
      if(!json || !json[month] || !Array.isArray(json[month])) throw new Error('Month not found in JSON');
      const sheet = json[month];
      const idx = sheet.findIndex(item=>{
        const flat = item['Flat Number'];
        const name = (item['Resident Name']||'').toString().trim().toLowerCase();
        const rName = (row.Name||'').toString().trim().toLowerCase();
        const flatStr = (flat==null? '' : String(Math.trunc(Number(flat)||flat)));
        const rowFlatStr = (row.Flat==null? '' : String(Math.trunc(Number(row.Flat)||row.Flat)));
        const flatMatch = flatStr === rowFlatStr;
        const nameMatch = !rName || !name ? flatMatch : (flatMatch && name===rName);
        return nameMatch;
      });
      if(idx===-1) throw new Error('Matching record not found in JSON');
      if(makePaid){
        sheet[idx]['Amount Received'] = 2000;
        sheet[idx]['Date'] = todayIso();
      }else{
        sheet[idx]['Amount Received'] = 0;
        sheet[idx]['Date'] = '';
      }
      const putRes = await fetch(UPDATE_BLOB_SAS_URL, { method:'PUT', headers:{'x-ms-blob-type':'BlockBlob','Content-Type':'application/json'}, body: JSON.stringify(json) });
      if(!putRes.ok) throw new Error('Blob update failed: HTTP '+putRes.status);
    }

    function populateMonthFilter(){
      if(!monthFilter) return;
      const seen = new Set();
      const options = ['<option value="all">All Months</option>'];
      rawData.forEach(r=>{
        if(r.Month && !seen.has(r.Month)){
          seen.add(r.Month);
          options.push('<option value="'+r.Month+'">'+r.Month+'</option>');
        }
      });
      monthFilter.innerHTML = options.join('');
    }

    monthFilter.addEventListener('change', render);
    searchBox.addEventListener('input', debounce(render,300));
    tabCollectedBtn.addEventListener('click',()=>{ 
      currentTab='collected'; 
      columnFilters={}; 
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      tabCollectedBtn.classList.add('active');
      document.getElementById('collectedContent').classList.add('active');
      render(); 
    });
    tabExpensesBtn.addEventListener('click',()=>{ 
      currentTab='expenses'; 
      expensesColumnFilters={}; 
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      tabExpensesBtn.classList.add('active');
      document.getElementById('expensesContent').classList.add('active');
      render(); 
    });
    tabFuture1Btn.addEventListener('click',()=>{ 
      currentTab='future1'; 
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      tabFuture1Btn.classList.add('active');
      document.getElementById('future1Content').classList.add('active');
      render(); 
    });
    tabFuture2Btn.addEventListener('click',()=>{ 
      currentTab='future2'; 
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      tabFuture2Btn.classList.add('active');
      document.getElementById('future2Content').classList.add('active');
      render(); 
    });
    function debounce(fn,wait){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn(...a),wait);};}

    // Clear all filters (summary section button)
    clearFiltersSummaryBtn.addEventListener('click',()=>{
      searchBox.value='';
      paidView='all';
      monthFilter.value='all';
      columnFilters={};
      expensesColumnFilters={};
      render();
    });

    // Load on page ready
    (async()=>{ await loadConfig(); await loadFromAzure(); })();

  </script>
</body>
</html>
